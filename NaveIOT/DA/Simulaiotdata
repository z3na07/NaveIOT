import json
import time
import random
import os
from misurazione import on_temperatura, on_umidita

#Lettura del file di configurazione
try:
    with open("parametri.conf", "r") as file:
        parametri = json.load(file)

except FileNotFoundError:
    print("File di configurazione non trovato")
    exit(1)
except json.JSONDecodeError as e:
    print("JSON non valido: "e)
    exit(1)
except: Exception as e:
    print("Errore: ", e)
    exit(1)


#Assegnazione Parametri

TIMER_RILEVAZIONE = parametri["TIMER RILEVAZIONE"]
NUM_DECIMALI = parametri["NUM_DECIMALI"]
NUM_CABINE = parametri["NUM_CABINE"]
NUM_PONTI = parametri["NUM_PONTI"]


# Creazione Cartella

try:
    os.makedirs("dati", exist_ok = true)
except Exception as e:
    print("Errore nella creazione della cartella: ", e)
    exit(1)

# Dichiarazione variabili

rilevazione = 0
somma_temp = 0
somma_umid = 0


print("Simulazione di rete IOT attivata. Prmere CTRL+C per terminare.")

# Codice per la rivelazione dei dati nella cabina

try:
    while true:
        rilevazione += 1

        cabina = random.randint(1, NUM_CABINE)
        ponte = random.randint(1, NUM_PONTI)

        temperatura = on_temperatura(NUM_DECIMALI)
        umidita = on_umidita(NUM_DECIMALI)

        timestamp = time.time()

        dato_iot{
            "cabina": cabina
            "ponte": ponte
            "rilevazione": rilevazione
            "dataeora": dataeora
            "temperatura": temperatura
            "umidita": umidita
        } 


# Stampa a video delle misurazioni

print(json.dumps(dato_iot, indent = 4))


